# ============================================================
# HTTP CONTEXT
# ============================================================

# ------------------------
# MIME & DEFAULTS
# ------------------------
default_type application/octet-stream;
sendfile on;
keepalive_timeout 65;

# ------------------------
# GLOBAL LIMITS
# ------------------------
client_max_body_size 10;

# ------------------------
# DEFAULT ERROR PAGES
# ------------------------

# ========================================================
# SERVER 1 – STATIC WEBSITE + UPLOADS
# ========================================================

server {
	listen 127.0.0.1:6969;
	# listen 8081;
	server_name site1.localhost;

	root ./www/site1;
	index index.html;

	error_page 400 /errors/400.html;
	error_page 403 /errors/403.html;
	error_page 404 /errors/404.html;
	error_page 405 /errors/405.html;
	error_page 413 /errors/413.html;
	error_page 414 /errors/414.html;
	error_page 500 /errors/500.html;
	error_page 502 /errors/502.html;

	# ------------------------
	# ERROR PAGES LOCATION
	# ------------------------
	location /errors {
		root ./www/common;
		internal;
	}

	# ------------------------
	# ROOT ROUTE
	# ------------------------
	location / {
		limit_except GET HEAD {
			deny all;
		}

		autoindex off;
	}

	# ------------------------
	# DIRECTORY LISTING
	# ------------------------
	location /public {
		root ./www/site1;
		autoindex on;
	}

	# ------------------------
	# HTTP REDIRECTION
	# ------------------------
	location /download {
		return 301 /public;
	}

	# ------------------------
	# FILE UPLOAD
	# ------------------------
	location /upload {
		limit_except POST {
			deny all;
		}

		client_max_body_size 50M;

		upload_store ./www/site1/uploads;
		upload_store_access user:rw group:rw all:r;
		upload_pass /upload_done;
	}

	location /upload_done {
		internal;
		return 201 "Upload OK\n";
	}
}

# ========================================================
# SERVER 2 – CGI (PHP + PYTHON)
# ========================================================

server {
	# listen 0.0.0.0:1;
	# listen 0.0.0.0:8080;
	# listen 127.0.0.1:1;
	# listen 127.0.0.1:1:2;
	listen 127.0.0.1:8080;
	listen 127.0.0.1:9090;
	# listen 127.0.0.1:0;
	server_name site2.localhost default;

	root ./www/site2;
	index index.php index.py index.html;

	# ------------------------
	# ERROR PAGES LOCATION
	# ------------------------
	location /errors {
		root ./www/common;
		internal;
	}

	# ------------------------
	# PHP CGI
	# ------------------------
	location ~ \.php$ {
		limit_except GET POST {
			deny all;
		}

		include fastcgi_params;

		fastcgi_pass unix:/run/php/php-cgi.sock;

		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param SCRIPT_NAME $fastcgi_script_name;
		fastcgi_param QUERY_STRING $query_string;
		fastcgi_param REQUEST_METHOD $request_method;
		fastcgi_param CONTENT_TYPE $content_type;
		fastcgi_param CONTENT_LENGTH $content_length;
		fastcgi_param DOCUMENT_ROOT $document_root;
	}

	# ------------------------
	# PYTHON CGI
	# ------------------------
	location ~ \.py$ {
		limit_except GET POST {
			deny all;
		}

		include fastcgi_params;

		fastcgi_pass unix:/run/fcgiwrap.socket;

		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param SCRIPT_NAME $fastcgi_script_name;
		fastcgi_param QUERY_STRING $query_string;
		fastcgi_param REQUEST_METHOD $request_method;
		fastcgi_param CONTENT_TYPE $content_type;
		fastcgi_param CONTENT_LENGTH $content_length;
	}

	# ------------------------
	# CGI DIRECTORY BEHAVIOR
	# ------------------------
	location /cgi-bin {
		autoindex off;
	}
}
